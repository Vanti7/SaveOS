name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  deploy-staging:
    name: Déploiement Staging
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push staging images
      run: |
        # Tag staging avec le SHA du commit (owner en minuscules)
        OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        TAG=ghcr.io/${OWNER_LC}/saveos:staging-${{ github.sha }}
        
        # Build & Push direct via Buildx (évite les IDs vides)
        docker buildx build --file Dockerfile.api --tag "$TAG-api" --push .
        docker buildx build --file Dockerfile.worker --tag "$TAG-worker" --push .
        docker buildx build --file web/Dockerfile --tag "$TAG-web" --push web

    - name: Deploy to staging environment
      run: |
        echo "🚀 Déploiement en staging"
        echo "Version: staging-${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        
        # Simulation du déploiement staging
        echo "📦 Images Docker taguées et prêtes"
        echo "🔧 Configuration staging appliquée"
        echo "🌐 Services staging démarrés"
        echo "✅ Déploiement staging simulé avec succès"

    - name: Run smoke tests on staging
      run: |
        echo "🧪 Tests de fumée sur staging"
        echo "🔍 Test de connectivité API staging"
        echo "🔍 Test de l'interface web staging" 
        echo "🔍 Test des services de base"
        echo "✅ Tous les tests de fumée sont passés (simulés)"

    - name: Notify staging deployment
      run: |
        echo "📢 Déploiement staging terminé"
        echo "🔗 URL: https://staging.saveos.com"
        # Ajouter notification Slack/Discord