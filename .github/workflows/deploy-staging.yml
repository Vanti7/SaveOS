name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  deploy-staging:
    name: DÃ©ploiement Staging
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push staging images
      run: |
        # Tag staging avec le SHA du commit (owner en minuscules)
        OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        TAG=ghcr.io/${OWNER_LC}/saveos:staging-${{ github.sha }}
        
        # Build & Push direct via Buildx (Ã©vite les IDs vides)
        docker buildx build --file Dockerfile.api --tag "$TAG-api" --push .
        docker buildx build --file Dockerfile.worker --tag "$TAG-worker" --push .
        docker buildx build --file web/Dockerfile --tag "$TAG-web" --push web

    - name: Deploy to staging environment
      run: |
        echo "ğŸš€ DÃ©ploiement en staging"
        echo "Version: staging-${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        
        # Simulation du dÃ©ploiement staging
        echo "ğŸ“¦ Images Docker taguÃ©es et prÃªtes"
        echo "ğŸ”§ Configuration staging appliquÃ©e"
        echo "ğŸŒ Services staging dÃ©marrÃ©s"
        echo "âœ… DÃ©ploiement staging simulÃ© avec succÃ¨s"

    - name: Run smoke tests on staging
      run: |
        echo "ğŸ§ª Tests de fumÃ©e sur staging"
        echo "ğŸ” Test de connectivitÃ© API staging"
        echo "ğŸ” Test de l'interface web staging" 
        echo "ğŸ” Test des services de base"
        echo "âœ… Tous les tests de fumÃ©e sont passÃ©s (simulÃ©s)"

    - name: Notify staging deployment
      run: |
        echo "ğŸ“¢ DÃ©ploiement staging terminÃ©"
        echo "ğŸ”— URL: https://staging.saveos.com"
        # Ajouter notification Slack/Discord